<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPI Payment Gateway</title>
    <style>
        /* (Keep all your existing CSS styles) */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
    <!-- (Keep all your existing HTML structure) -->

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCn553qWsVz2VF1dZ4Ji5OkQDGFvMORbJE",
            authDomain: "pg-data-ed1c2.firebaseapp.com",
            databaseURL: "https://pg-data-ed1c2-default-rtdb.firebaseio.com",
            projectId: "pg-data-ed1c2",
            storageBucket: "pg-data-ed1c2.firebasestorage.app",
            messagingSenderId: "884858492190",
            appId: "1:884858492190:web:67b7606ff790064ef3250f",
            measurementId: "G-J73RD8EH7W"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Reference to payment data in Firebase
        const paymentRef = database.ref('payments/currentPayment');

        // DOM elements
        const countdownElement = document.getElementById('countdown');
        const amountElement = document.getElementById('amount');
        const upiIdElement = document.getElementById('upiId');
        const qrImageElement = document.getElementById('qrImage');
        const statusMessageElement = document.getElementById('statusMessage');

        // Variables
        let timerInterval;
        let paymentData = {};

        // Fetch payment data from Firebase
        paymentRef.on('value', (snapshot) => {
            paymentData = snapshot.val();
            if (paymentData) {
                updatePaymentUI(paymentData);
                
                // Calculate expiry time (createdAt + expiryMinutes)
                const expiryTime = paymentData.createdAt + (paymentData.expiryMinutes * 60);
                startTimer(expiryTime);
                
                // Check payment status
                if (paymentData.status === 'paid') {
                    showPaymentSuccess();
                } else if (paymentData.status === 'expired') {
                    showPaymentExpired();
                }
            } else {
                showError("Payment session not found");
            }
        });

        function updatePaymentUI(data) {
            // Update amount with Indian Rupee formatting
            const formattedAmount = new Intl.NumberFormat('en-IN', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(data.amount);
            amountElement.textContent = formattedAmount;

            // Update UPI ID
            upiIdElement.textContent = data.upiId;

            // Generate QR code with UPI payment details
            const qrData = `upi://pay?pa=${encodeURIComponent(data.upiId)}&pn=${encodeURIComponent('Your Merchant Name')}&am=${data.amount}&tn=${encodeURIComponent(data.transactionId)}&cu=INR`;
            qrImageElement.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;
            
            // Show loading until QR loads
            qrImageElement.onload = () => {
                document.querySelector('.qr-code').classList.remove('loading');
            };
            qrImageElement.onerror = () => {
                showError("Failed to generate QR code");
            };
        }

        function startTimer(expiryTimestamp) {
            // Clear existing timer if any
            if (timerInterval) clearInterval(timerInterval);

            function updateTimerDisplay() {
                const now = Math.floor(Date.now() / 1000);
                const timeLeft = expiryTimestamp - now;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    countdownElement.textContent = "Expired";
                    document.querySelector('.timer').style.backgroundColor = 'var(--error-color)';
                    
                    // Update status in Firebase
                    paymentRef.update({ status: 'expired' });
                    return;
                }

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Change color when less than 1 minute remaining
                if (timeLeft < 60) {
                    document.querySelector('.timer').style.backgroundColor = 'var(--error-color)';
                }
            }

            // Update immediately and then every second
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function showPaymentSuccess() {
            statusMessageElement.style.display = 'block';
            document.querySelector('.timer').style.backgroundColor = 'var(--success-color)';
            countdownElement.textContent = "Paid";
            clearInterval(timerInterval);
            
            // Disable copy button
            document.querySelector('.copy-btn').disabled = true;
        }

        function showPaymentExpired() {
            clearInterval(timerInterval);
            countdownElement.textContent = "Expired";
            document.querySelector('.timer').style.backgroundColor = 'var(--error-color)';
            document.querySelector('.copy-btn').disabled = true;
        }

        // Copy UPI ID function
        function copyUPI() {
            if (!paymentData.upiId) return;
            
            navigator.clipboard.writeText(paymentData.upiId).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="far fa-copy"></i> Copy';
                }, 2000);
            });
        }

        // Button functions
        function cancelPayment() {
            if (confirm('Are you sure you want to cancel this payment?')) {
                // Update status in Firebase
                paymentRef.update({ status: 'expired' })
                    .then(() => {
                        alert('Payment cancelled. You will be redirected.');
                    })
                    .catch((error) => {
                        alert('Error cancelling payment: ' + error.message);
                    });
            }
        }

        function showHelp() {
            alert('For assistance, please contact our customer support at support@example.com or call +91 9876543210.');
        }

        function showError(message) {
            countdownElement.textContent = "Error";
            amountElement.textContent = "--";
            upiIdElement.textContent = message;
            document.querySelector('.timer').style.backgroundColor = 'var(--error-color)';
            document.querySelector('.qr-code img').style.display = 'none';
        }

        // Initialize
        document.querySelector('.qr-code').classList.add('loading');
    </script>
</body>
</html>
